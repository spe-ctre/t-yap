generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION MODELS
// ============================================

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  phoneNumber     String   @unique
  password        String
  isEmailVerified Boolean  @default(false)
  isPhoneVerified Boolean  @default(false)
  role            UserRole @default(PASSENGER)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  passenger         Passenger?
  driver            Driver?
  agent             Agent?
  parkManager       ParkManager?
  verificationCodes VerificationCode[]
  transactions      Transaction[]
  bankAccounts      BankAccount[]
  beneficiaries     Beneficiary[]
  notifications     Notification[]
  userSettings      UserSettings?
  trips             Trip[] // As passenger
  vasPurchases      VASPurchase[]
  balanceHistory    BalanceHistory[] // ‚Üê ADD THIS LINE
  sentTransfers     Transfer[]         @relation("SentTransfers")
  receivedTransfers Transfer[]         @relation("ReceivedTransfers")
  sessions          UserSession[]
  idempotencyKeys   IdempotencyKey[]
  transactionLogs   TransactionLog[]
  securityQuestion  SecurityQuestion?
  deviceTokens      DeviceToken[]
  supportTickets    SupportTicket[]

  @@map("users")
}

enum UserType {
  PASSENGER
  DRIVER
  AGENT
  PARK_MANAGER
}

model Passenger {
  id             String  @id @default(cuid())
  userId         String  @unique
  firstName      String?
  lastName       String?
  biometricData  String? // Encrypted biometric template
  transactionPin String?
  walletBalance  Decimal @default(0) @db.Decimal(10, 2)
  profilePicture String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("passengers")
}

model Driver {
  id             String   @id @default(cuid())
  userId         String   @unique
  firstName      String
  lastName       String
  licenseNumber  String   @unique
  licenseExpiry  DateTime
  isVerified     Boolean  @default(false)
  walletBalance  Decimal  @default(0) @db.Decimal(10, 2)
  profilePicture String?

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle Vehicle?
  trips   Trip[]   @relation("TripDriver")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([licenseNumber])
  @@map("drivers")
}

model Agent {
  id            String  @id @default(cuid())
  userId        String  @unique
  firstName     String
  lastName      String
  agentCode     String  @unique
  parkId        String?
  walletBalance Decimal @default(0) @db.Decimal(10, 2)
  isActive      Boolean @default(true)

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  park Park? @relation(fields: [parkId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([agentCode])
  @@map("agents")
}

model ParkManager {
  id        String  @id @default(cuid())
  userId    String  @unique
  firstName String
  lastName  String
  parkId    String?

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  park Park? @relation(fields: [parkId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("park_managers")
}

model VerificationCode {
  id        String           @id @default(cuid())
  userId    String
  code      String
  type      VerificationType
  expiresAt DateTime
  isUsed    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, code, type])
  @@index([expiresAt])
  @@map("verification_codes")
}

// ============================================
// TRANSACTION & WALLET MODELS
// ============================================

model Transaction {
  id            String              @id @default(cuid())
  userId        String
  userType      UserType
  type          TransactionType
  category      TransactionCategory
  amount        Decimal             @db.Decimal(10, 2)
  balanceBefore Decimal             @db.Decimal(10, 2)
  balanceAfter  Decimal             @db.Decimal(10, 2)
  status        TransactionStatus   @default(PENDING)
  description   String?
  reference     String              @unique // External payment reference
  metadata      Json? // Additional data (service provider, phone number, etc.)
  tripId        String?             @unique // If transaction is for a trip
  vasPurchaseId String?             @unique // If transaction is for VAS

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  trip        Trip?        @relation(fields: [tripId], references: [id])
  vasPurchase VASPurchase? @relation(fields: [vasPurchaseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([reference])
  @@index([tripId])
  @@index([vasPurchaseId])
  @@map("transactions")
}

model Transfer {
  id String @id @default(cuid())

  // Sender & Recipient
  senderId String
  sender   User   @relation("SentTransfers", fields: [senderId], references: [id], onDelete: Cascade)

  recipientId String
  recipient   User   @relation("ReceivedTransfers", fields: [recipientId], references: [id], onDelete: Cascade)

  // Transfer Details
  amount      Decimal @db.Decimal(10, 2)
  description String?
  reference   String  @unique @default(cuid())

  // Status & Tracking
  status TransferStatus @default(PENDING)

  // Link to transactions (for accounting)
  debitTransactionId  String? @unique
  creditTransactionId String? @unique

  // Scheduling fields
  isScheduled  Boolean   @default(false)
  scheduledFor DateTime? // When to execute the transfer

  // Recurring transfer fields
  isRecurring        Boolean             @default(false)
  recurringFrequency RecurringFrequency?
  nextExecutionDate  DateTime?
  lastExecutionDate  DateTime?
  recurringEndDate   DateTime? // Optional end date for recurring transfers
  executionCount     Int                 @default(0) // How many times it has executed
  maxExecutions      Int? // Optional maximum number of executions
  parentTransferId   String? // If this is a recurring execution, link to the parent
  recurringPinHash   String? // Store encrypted PIN for recurring transfers

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  cancelledAt DateTime?

  @@index([senderId])
  @@index([recipientId])
  @@index([status])
  @@index([createdAt])
  @@index([reference])
  @@index([isScheduled, scheduledFor])
  @@index([isRecurring, nextExecutionDate])
  @@map("transfers")
}

model BankAccount {
  id            String          @id @default(cuid())
  userId        String
  accountName   String
  accountNumber String
  bankName      String
  bankCode      String?
  accountType   BankAccountType @default(SAVINGS)
  isDefault     Boolean         @default(false)
  isVerified    Boolean         @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([accountNumber, bankCode])
  @@map("bank_accounts")
}

model BankCard {
  id             String  @id @default(cuid())
  userId         String
  cardNumber     String // Last 4 digits only (encrypted)
  cardHolderName String
  expiryMonth    Int
  expiryYear     Int
  cvv            String? // Encrypted, should not be stored long-term
  cardType       String? // Visa, Mastercard, etc.
  isDefault      Boolean @default(false)
  isActive       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("bank_cards")
}

model Beneficiary {
  id            String  @id @default(cuid())
  userId        String
  name          String
  phoneNumber   String
  accountNumber String?
  bankName      String?
  isFavorite    Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([phoneNumber])
  @@map("beneficiaries")
}

// ============================================
// TRANSPORT MODELS (T-RIDE)
// ============================================

model Park {
  id        String   @id @default(cuid())
  name      String
  address   String
  city      String
  state     String
  country   String   @default("Nigeria")
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)
  isActive  Boolean  @default(true)

  agents            Agent[]
  parkManagers      ParkManager[]
  originRoutes      Route[]       @relation("OriginPark")
  destinationRoutes Route[]       @relation("DestinationPark")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city, state])
  @@map("parks")
}

model Route {
  id                String   @id @default(cuid())
  name              String // e.g., "Lagos to Ibadan"
  origin            String
  destination       String
  originParkId      String?
  destinationParkId String?
  distance          Decimal? @db.Decimal(10, 2) // in kilometers
  estimatedTime     Int? // in minutes
  baseFare          Decimal  @db.Decimal(10, 2)
  isActive          Boolean  @default(true)

  originPark      Park?  @relation("OriginPark", fields: [originParkId], references: [id])
  destinationPark Park?  @relation("DestinationPark", fields: [destinationParkId], references: [id])
  trips           Trip[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([origin, destination])
  @@index([isActive])
  @@map("routes")
}

model Vehicle {
  id          String      @id @default(cuid())
  driverId    String      @unique
  plateNumber String      @unique
  make        String // e.g., "Toyota"
  model       String // e.g., "Hiace"
  year        Int?
  color       String?
  capacity    Int // Number of seats
  vehicleType VehicleType
  isVerified  Boolean     @default(false)
  isActive    Boolean     @default(true)

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)
  trips  Trip[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@index([plateNumber])
  @@map("vehicles")
}

model Trip {
  id              String     @id @default(cuid())
  routeId         String
  driverId        String
  vehicleId       String
  passengerId     String
  fare            Decimal    @db.Decimal(10, 2)
  status          TripStatus @default(PENDING)
  departureTime   DateTime?
  arrivalTime     DateTime?
  originLatitude  Decimal?   @db.Decimal(10, 8)
  originLongitude Decimal?   @db.Decimal(11, 8)
  destLatitude    Decimal?   @db.Decimal(10, 8)
  destLongitude   Decimal?   @db.Decimal(11, 8)

  route       Route        @relation(fields: [routeId], references: [id])
  driver      Driver       @relation("TripDriver", fields: [driverId], references: [id])
  vehicle     Vehicle      @relation(fields: [vehicleId], references: [id])
  user        User         @relation(fields: [passengerId], references: [id])
  transaction Transaction? @relation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([passengerId])
  @@index([driverId])
  @@index([routeId])
  @@index([status])
  @@index([createdAt])
  @@map("trips")
}

// ============================================
// VALUE ADDED SERVICES (VAS) MODELS
// ============================================

model ServiceProvider {
  id       String      @id @default(cuid())
  name     String
  category VASCategory
  code     String      @unique // Provider code (e.g., "MTN", "IKEDC")
  logo     String?
  isActive Boolean     @default(true)

  vasPurchases VASPurchase[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([code])
  @@map("service_providers")
}

model VASPurchase {
  id                String            @id @default(cuid())
  userId            String
  serviceProviderId String
  category          VASCategory
  amount            Decimal           @db.Decimal(10, 2)
  phoneNumber       String? // For airtime/data
  meterNumber       String? // For electricity
  smartCardNumber   String? // For cable TV
  packageName       String? // Selected package/plan
  status            VASPurchaseStatus @default(PENDING)
  providerReference String? // Provider's transaction reference
  metadata          Json? // Additional provider-specific data

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceProvider ServiceProvider @relation(fields: [serviceProviderId], references: [id])
  transaction     Transaction?    @relation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@map("vas_purchases")
}

// ============================================
// NOTIFICATION & SETTINGS MODELS
// ============================================

model Notification {
  id       String           @id @default(cuid())
  userId   String
  type     NotificationType
  title    String
  message  String
  isRead   Boolean          @default(false)
  metadata Json? // Additional data

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model UserSettings {
  id                String  @id @default(cuid())
  userId            String  @unique
  language          String  @default("en") // en, ha, ig, yo
  darkMode          Boolean @default(false)
  biometricLogin    Boolean @default(false)
  smsNotification   Boolean @default(true)
  emailNotification Boolean @default(true)
  pushNotification  Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("user_settings")
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  deviceId     String? // Unique device identifier
  deviceName   String? // e.g., "iPhone 13", "Samsung Galaxy"
  deviceType   String? // MOBILE, TABLET, WEB
  ipAddress    String?
  userAgent    String?
  isActive     Boolean  @default(true)
  lastActivity DateTime @default(now())
  expiresAt    DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([deviceId])
  @@map("user_sessions")
}

// ============================================
// IDEMPOTENCY & LOGGING MODELS
// ============================================

model IdempotencyKey {
  id          String   @id @default(cuid())
  key         String   @unique
  userId      String
  requestHash String
  response    Json?
  status      String // PENDING, COMPLETED, FAILED
  expiresAt   DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([key])
  @@index([userId])
  @@index([expiresAt])
  @@map("idempotency_keys")
}

model TransactionLog {
  id            String  @id @default(cuid())
  transactionId String?
  vasPurchaseId String?
  userId        String
  logType       String // REQUEST, RESPONSE, ERROR, WEBHOOK, REQUERY
  level         String // INFO, WARN, ERROR, DEBUG
  message       String
  requestData   Json?
  responseData  Json?
  provider      String?
  endpoint      String?
  statusCode    Int?
  duration      Int?
  ipAddress     String?
  userAgent     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([transactionId])
  @@index([vasPurchaseId])
  @@index([logType])
  @@index([createdAt])
  @@map("transaction_logs")
}

// ============================================
// SECURITY & SUPPORT MODELS
// ============================================

model SecurityQuestion {
  id        String @id @default(cuid())
  userId    String @unique
  question1 String
  answer1   String
  question2 String
  answer2   String
  question3 String
  answer3   String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("security_questions")
}

model DeviceToken {
  id       String  @id @default(cuid())
  userId   String
  token    String  @unique
  platform String // iOS, Android, Web
  isActive Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@map("device_tokens")
}

model SupportTicket {
  id          String              @id @default(cuid())
  userId      String
  subject     String
  message     String
  category    SupportCategory
  status      SupportTicketStatus @default(OPEN)
  priority    TicketPriority      @default(NORMAL)
  attachments Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([category])
  @@map("support_tickets")
}

model FAQ {
  id          String   @id @default(cuid())
  question    String
  answer      String
  category    String
  tags        String[]
  order       Int      @default(0)
  isPublished Boolean  @default(true)
  viewCount   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isPublished])
  @@map("faqs")
}

model HelpContent {
  id          String   @id @default(cuid())
  title       String
  content     String
  category    String
  slug        String   @unique
  tags        String[]
  order       Int      @default(0)
  isPublished Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([slug])
  @@index([isPublished])
  @@map("help_content")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  PASSENGER
  DRIVER
  AGENT
  PARK_MANAGER
}

enum VerificationType {
  EMAIL_VERIFICATION
  PHONE_VERIFICATION
  PASSWORD_RESET
  PIN_RESET
}

enum TransactionType {
  CREDIT // Money coming in (top-up, refund)
  DEBIT // Money going out (payment, purchase)
}

enum TransactionCategory {
  WALLET_TOPUP
  FARE_PAYMENT
  AIRTIME_PURCHASE
  DATA_PURCHASE
  ELECTRICITY_PAYMENT
  CABLE_TV_PAYMENT
  EDUCATION_PAYMENT
  TRANSFER
  REFUND
  COMMISSION // For drivers/agents
}

enum TransactionStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  CANCELLED
  REFUNDED
}

enum BankAccountType {
  SAVINGS
  CURRENT
}

enum VehicleType {
  BUS
  TRICYCLE
  TAXI
  MINIBUS
  SEDAN
}

enum TripStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum VASCategory {
  AIRTIME
  DATA
  ELECTRICITY
  CABLE_TV
  EDUCATION
}

enum VASPurchaseStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  REFUNDED
}

enum NotificationType {
  TRANSACTION
  WALLET_FUNDED
  TRIP_CONFIRMED
  TRIP_COMPLETED
  SYSTEM
  PROMOTIONAL
}

enum SupportCategory {
  ACCOUNT
  PAYMENT
  TECHNICAL
  FEEDBACK
  OTHER
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TransferStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  SCHEDULED
  REFUNDED
}

enum RecurringFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

model BalanceHistory {
  id           String   @id @default(cuid())
  userId       String
  userType     UserType
  balance      Decimal  @db.Decimal(10, 2)
  snapshotDate DateTime @default(now())
  reconciled   Boolean  @default(false)
  discrepancy  Decimal? @db.Decimal(10, 2) // Difference if reconciliation failed
  metadata     Json? // Additional reconciliation info

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([snapshotDate])
  @@index([reconciled])
  @@map("balance_history")
}
